{{- range $app := .Values.applications }}
---
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: {{ $.Values.project }}-{{ $app.name }}-build-workflow-template
  namespace: {{ $.Values.project }}
spec:
  serviceAccountName: {{ $.Values.project }}-ci-workflow-sa
  entrypoint: ci-pipeline
  arguments:
    parameters:
      - name: github-event-type
        value: ""
      - name: github-sha
        value: ""
  volumes:
    - name: docker-config
      secret:
        secretName: registry-secret
        items:
          - key: .dockerconfigjson
            path: config.json
  templates:
    - name: ci-pipeline
      dag:
        tasks:
          - name: get-latest-sha
            template: fetch-latest-commit-sha
            when: "{{`{{workflow.parameters.github-event-type}}`}} != 'push'"

          - name: commit-status-start
            template: commit-status
            depends: "(get-latest-sha.Succeeded || get-latest-sha.Skipped)"
            arguments:
              parameters:
                - name: state
                  value: "pending"
                - name: description
                  value: "{{ $app.name }} 애플리케이션 빌드를 시작합니다"
                - name: context
                  value: "ci/{{ $.Values.project }}-{{ $app.name }}"
                - name: sha
                  value: "{{`{{= workflow.parameters['github-event-type'] == 'push' ? workflow.parameters['github-sha'] : tasks['get-latest-sha'].outputs.parameters['commit-sha'] }}`}}"

          - name: build-container
            template: build-container
            depends: "(get-latest-sha.Succeeded || get-latest-sha.Skipped)"
            arguments:
              parameters:
                - name: sha
                  value: "{{`{{= workflow.parameters['github-event-type'] == 'push' ? workflow.parameters['github-sha'] : tasks['get-latest-sha'].outputs.parameters['commit-sha'] }}`}}"

          - name: commit-status-build-success
            template: commit-status
            depends: "build-container.Succeeded"
            arguments:
              parameters:
                - name: state
                  value: "pending"
                - name: description
                  value: "{{ $app.name }} 빌드 완료 - 배포 준비 중"
                - name: context
                  value: "ci/{{ $.Values.project }}-{{ $app.name }}"
                - name: sha
                  value: "{{`{{= workflow.parameters['github-event-type'] == 'push' ? workflow.parameters['github-sha'] : tasks['get-latest-sha'].outputs.parameters['commit-sha'] }}`}}"

          - name: commit-status-build-failed
            template: commit-status
            depends: "build-container.Failed"
            arguments:
              parameters:
                - name: state
                  value: "failure"
                - name: description
                  value: "{{ $app.name }} 빌드 과정에서 오류가 발생했습니다"
                - name: context
                  value: "ci/{{ $.Values.project }}-{{ $app.name }}"
                - name: sha
                  value: "{{`{{= workflow.parameters['github-event-type'] == 'push' ? workflow.parameters['github-sha'] : tasks['get-latest-sha'].outputs.parameters['commit-sha'] }}`}}"

          - name: update-config
            template: update-config
            depends: "build-container.Succeeded"
            arguments:
              parameters:
                - name: sha
                  value: "{{`{{= workflow.parameters['github-event-type'] == 'push' ? workflow.parameters['github-sha'] : tasks['get-latest-sha'].outputs.parameters['commit-sha'] }}`}}"

          - name: commit-status-success
            template: commit-status
            depends: "update-config.Succeeded"
            arguments:
              parameters:
                - name: state
                  value: "success"
                - name: description
                  value: "{{ $app.name }} 빌드 및 배포 트리거 성공"
                - name: context
                  value: "ci/{{ $.Values.project }}-{{ $app.name }}"
                - name: sha
                  value: "{{`{{= workflow.parameters['github-event-type'] == 'push' ? workflow.parameters['github-sha'] : tasks['get-latest-sha'].outputs.parameters['commit-sha'] }}`}}"

          - name: commit-status-failed
            template: commit-status
            depends: "update-config.Failed"
            arguments:
              parameters:
                - name: state
                  value: "failure"
                - name: description
                  value: "{{ $app.name }} 배포 트리거 과정에서 오류가 발생했습니다"
                - name: context
                  value: "ci/{{ $.Values.project }}-{{ $app.name }}"
                - name: sha
                  value: "{{`{{= workflow.parameters['github-event-type'] == 'push' ? workflow.parameters['github-sha'] : tasks['get-latest-sha'].outputs.parameters['commit-sha'] }}`}}"

    - name: fetch-latest-commit-sha
      script:
        image: alpine:3.18
        imagePullPolicy: IfNotPresent
        command: [sh]
        source: |
          set -e
          apk add --no-cache curl jq

          COMMIT_SHA=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/{{ $app.git.owner }}/{{ $app.git.repo }}/branches/{{ $app.git.branch }}" \
            | jq -r '.commit.sha')
          echo "$COMMIT_SHA" > /tmp/commit_sha.txt
        env:
          - name: GITHUB_TOKEN
            valueFrom:
              secretKeyRef:
                name: {{ $.Values.project }}-github-access-secret
                key: token
      outputs:
        parameters:
          - name: commit-sha
            valueFrom:
              path: /tmp/commit_sha.txt
    
    - name: commit-status
      inputs:
        parameters:
          - name: state
          - name: description
          - name: context
          - name: sha
      script:
        image: curlimages/curl:latest
        imagePullPolicy: IfNotPresent
        command: [sh]
        source: |
          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            -d '{
              "state": "{{`{{inputs.parameters.state}}`}}",
              "description": "{{`{{inputs.parameters.description}}`}}",
              "context": "{{`{{inputs.parameters.context}}`}}"
            }' \
            "https://api.github.com/repos/{{ $app.git.owner }}/{{ $app.git.repo }}/statuses/{{`{{inputs.parameters.sha}}`}}"
        env:
          - name: GITHUB_TOKEN
            valueFrom:
              secretKeyRef:
                name: {{ $.Values.project }}-github-access-secret
                key: token
    
    - name: build-container
      inputs:
        parameters:
          - name: sha
      volumes:
        - name: docker-config
          secret:
            secretName: registry-secret
            items:
              - key: .dockerconfigjson
                path: config.json
      script:
        image: docker:cli
        imagePullPolicy: IfNotPresent
        command: [sh]
        source: |
          set -e

          GIT_SHA="{{`{{inputs.parameters.sha}}`}}"
          IMAGE="harbor.injunweb.com/injunweb/{{ $.Values.project }}-{{ $app.name }}"
          GIT_CONTEXT="https://github.com/{{ $app.git.owner }}/{{ $app.git.repo }}.git#${GIT_SHA}"

          docker buildx create --name builder --driver remote tcp://buildkit.buildkit.svc.cluster.local:1234 --use

          GIT_AUTH_TOKEN="${GITHUB_TOKEN}" docker buildx build -f Dockerfile \
            --secret id=GIT_AUTH_TOKEN \
            -t "${IMAGE}:latest" -t "${IMAGE}:${GIT_SHA}" \
            --platform linux/amd64 --progress plain --provenance false --sbom false \
            --output type=image,compression=zstd,compression-level=3,oci-mediatypes=true,push=true \
            "${GIT_CONTEXT}"
        env:
          - name: GITHUB_TOKEN
            valueFrom:
              secretKeyRef:
                name: {{ $.Values.project }}-github-access-secret
                key: token
          - name: DOCKER_CONFIG
            value: /docker-config
          - name: BUILDX_CONFIG
            value: /tmp/buildx
        volumeMounts:
          - name: docker-config
            mountPath: /docker-config
    
    - name: update-config
      inputs:
        parameters:
          - name: sha
      script:
        image: curlimages/curl:latest
        imagePullPolicy: IfNotPresent
        command: [sh]
        source: |
          curl -X POST https://api.github.com/repos/injunweb/projects-gitops/dispatches \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -d '{
              "event_type": "config-api",
              "client_payload": {
                "path": "projects/{{$.Values.project}}/applications/{{$app.name}}",
                "action": "apply",
                "spec": {
                  "git": {
                    "hash": "'"{{`{{inputs.parameters.sha}}`}}"'"
                  }
                }
              }
            }'
        env:
          - name: GITHUB_TOKEN
            valueFrom:
              secretKeyRef:
                name: {{ $.Values.project }}-github-access-secret
                key: token
{{- end }}